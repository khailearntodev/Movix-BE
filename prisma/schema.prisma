generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum cho trạng thái người dùng 
enum UserStatus {
  active
  inactive
  locked
  pending_verification
}

// Enum cho loại credit 
enum CreditType {
  cast
  crew
}

//Enum cho loại phim
enum MediaType {
  MOVIE
  TV
}

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  is_deleted  Boolean  @default(false)
  users       User[]
}

model User {
  id                  String     @id @default(uuid()) @db.Uuid
  username            String     @unique
  password            String
  email               String     @unique
  display_name        String
  is_online           Boolean?
  avatar_url          String?
  preferences         Json?
  role_id             String?    @db.Uuid
  created_at          DateTime   @default(now())
  updated_at          DateTime   @updatedAt
  is_deleted          Boolean    @default(false)
  status              UserStatus @default(pending_verification)
  is_flagged          Boolean    @default(false)
  last_login_at       DateTime?
  verificationCode    String?
  verificationExpires DateTime?

  // Relations
  role                 Role?              @relation(fields: [role_id], references: [id], onDelete: SetNull)
  refreshTokens        RefreshToken[]
  password_resets      PasswordReset[]
  ratings              Rating[]
  comments             Comment[]
  watch_history        WatchHistory[]
  favourites           Favourite[]
  playlists            Playlist[]
  notifications        Notification[]
  chatbot_logs         ChatbotLog[]
  hosted_watch_parties WatchParty[]       @relation("HostUser")
  watch_party_members  WatchPartyMember[]
  user_flag_logs       UserFlagLog[]      @relation("FlaggedUser")
  admin_flag_logs      UserFlagLog[]      @relation("AdminUser")
}

model PasswordReset {
  id          String   @id @default(uuid()) @db.Uuid
  user_id     String   @db.Uuid
  reset_token String   @unique
  expires_at  DateTime
  created_at  DateTime @default(now())
  is_used     Boolean  @default(false)
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Country {
  id     String  @id @default(uuid()) @db.Uuid
  name   String  @unique @db.VarChar(150)
  movies Movie[]
}

model Movie {
  id             String    @id @default(uuid()) @db.Uuid
  original_title String
  slug           String    @unique
  tmdb_id        Int?
  media_type     MediaType
  title          String
  poster_url     String?
  backdrop_url   String?
  trailer_url    String?
  description    String?
  release_date   DateTime? @db.Date
  country_id     String?   @db.Uuid
  metadata       Json?
  is_active      Boolean   @default(true)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  is_deleted     Boolean   @default(false)

  // Relations
  country         Country?           @relation(fields: [country_id], references: [id], onDelete: SetNull)
  movie_genres    MovieGenre[]
  movie_people    MoviePerson[]
  ratings         Rating[]
  comments        Comment[]
  seasons         Season[]
  favourites      Favourite[]
  playlist_movies PlaylistMovie[]
  watch_parties   WatchParty[]
  section_links   SectionMovieLink[]

  @@unique([tmdb_id, media_type])
  @@map("movies")
}

model Genre {
  id           String       @id @default(uuid()) @db.Uuid
  name         String       @unique
  created_at   DateTime     @default(now())
  updated_at   DateTime     @updatedAt
  is_deleted   Boolean      @default(false)
  movie_genres MovieGenre[]
}

model MovieGenre {
  id         String   @id @default(uuid()) @db.Uuid
  movie_id   String   @db.Uuid
  genre_id   String   @db.Uuid
  created_at DateTime @default(now())
  is_deleted Boolean  @default(false)
  movie      Movie    @relation(fields: [movie_id], references: [id], onDelete: Cascade)
  genre      Genre    @relation(fields: [genre_id], references: [id], onDelete: Cascade)

  @@unique([movie_id, genre_id])
}

model Person {
  id           String        @id @default(uuid()) @db.Uuid
  tmdb_id      Int?          @unique
  name         String        @db.VarChar(300)
  biography    String?
  stage_name   String?       @db.VarChar(300)
  birthday     DateTime?     @db.Date
  gender       Int?          //1 = Nữ, 2 = Nam, 0 = Không rõ, 3 = Non-binary
  role_type    String        @db.VarChar(50) // "actor", "director", "writer"...
  avatar_url   String?
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt
  is_deleted   Boolean       @default(false)
  movie_people MoviePerson[]
}

model MoviePerson {
  id          String     @id @default(uuid()) @db.Uuid
  movie_id    String     @db.Uuid
  person_id   String     @db.Uuid
  credit_type CreditType // Sử dụng Enum từ CHECK
  character   String?    @db.VarChar(300)
  ordering    Int        @default(0) 
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt
  is_deleted  Boolean    @default(false)
  movie       Movie      @relation(fields: [movie_id], references: [id], onDelete: Cascade)
  person      Person     @relation(fields: [person_id], references: [id], onDelete: Cascade)

  @@unique([movie_id, person_id, credit_type, character])
}

model Rating {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  movie_id   String   @db.Uuid
  rating     Int? // SQL có CHECK, Prisma không enforce, nhưng CSDL sẽ enforce
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  is_deleted Boolean  @default(false)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  movie      Movie    @relation(fields: [movie_id], references: [id], onDelete: Cascade)

  @@unique([user_id, movie_id])
}

model Comment {
  id                String   @id @default(uuid()) @db.Uuid
  user_id           String   @db.Uuid
  movie_id          String   @db.Uuid
  comment           String
  is_spoiler        Boolean  @default(false)
  parent_comment_id String?  @db.Uuid
  is_hidden         Boolean  @default(false)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  is_deleted        Boolean  @default(false)

  user           User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  movie          Movie     @relation(fields: [movie_id], references: [id], onDelete: Cascade)
  parent_comment Comment?  @relation("Replies", fields: [parent_comment_id], references: [id], onDelete: SetNull)
  replies        Comment[] @relation("Replies")
}

model Season {
  id            String   @id @default(uuid()) @db.Uuid
  movie_id      String   @db.Uuid
  season_number Int
  title         String?  @db.VarChar(300)
  overview      String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  is_deleted    Boolean  @default(false)

  movie    Movie     @relation(fields: [movie_id], references: [id], onDelete: Cascade)
  episodes Episode[]

  @@unique([movie_id, season_number])
}

model Episode {
  id             String   @id @default(uuid()) @db.Uuid
  season_id      String   @db.Uuid
  episode_number Int
  title          String?  @db.VarChar(300)
  runtime        Int?
  video_url      String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  is_deleted     Boolean  @default(false)

  season        Season         @relation(fields: [season_id], references: [id], onDelete: Cascade)
  watch_history WatchHistory[]
  watch_parties WatchParty[]

  @@unique([season_id, episode_number])
}

model WatchHistory {
  id               String   @id @default(uuid()) @db.Uuid
  user_id          String   @db.Uuid
  episode_id       String   @db.Uuid
  watched_at       DateTime @default(now())
  is_deleted       Boolean  @default(false)
  progress_seconds Int      @default(0)
  is_finished      Boolean  @default(false)

  user    User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  episode Episode @relation(fields: [episode_id], references: [id], onDelete: Cascade)

  @@unique([user_id, episode_id])
}

model Favourite {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  movie_id   String   @db.Uuid
  created_at DateTime @default(now())
  is_deleted Boolean  @default(false)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  movie      Movie    @relation(fields: [movie_id], references: [id], onDelete: Cascade)

  @@unique([user_id, movie_id])
}

model Playlist {
  id          String   @id @default(uuid()) @db.Uuid
  user_id     String   @db.Uuid
  name        String
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  is_deleted  Boolean  @default(false)

  user            User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  playlist_movies PlaylistMovie[]
}

model PlaylistMovie {
  id          String   @id @default(uuid()) @db.Uuid
  playlist_id String   @db.Uuid
  movie_id    String   @db.Uuid
  created_at  DateTime @default(now())
  is_deleted  Boolean  @default(false)

  playlist Playlist @relation(fields: [playlist_id], references: [id], onDelete: Cascade)
  movie    Movie    @relation(fields: [movie_id], references: [id], onDelete: Cascade)

  @@unique([playlist_id, movie_id])
}

model Notification {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String?  @db.Uuid
  message    String
  is_read    Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  is_deleted Boolean  @default(false)
  user       User?    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model ChatbotLog {
  id           String   @id @default(uuid()) @db.Uuid
  user_id      String?  @db.Uuid
  user_message String?
  bot_response String?
  created_at   DateTime @default(now())
  user         User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)
}

model Banner {
  id         String   @id @default(uuid()) @db.Uuid
  title      String
  image_url  String?
  link_url   String?
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  is_deleted Boolean  @default(false)
}

model WatchParty {
  id           String    @id @default(uuid()) @db.Uuid
  host_user_id String    @db.Uuid
  movie_id     String?   @db.Uuid
  episode_id   String?   @db.Uuid
  title        String?
  is_private   Boolean   @default(false)
  join_code    String?   @unique @db.VarChar(10)
  started_at   DateTime?
  is_active    Boolean   @default(true)
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  host_user User               @relation("HostUser", fields: [host_user_id], references: [id], onDelete: Cascade)
  movie     Movie?             @relation(fields: [movie_id], references: [id], onDelete: SetNull)
  episode   Episode?           @relation(fields: [episode_id], references: [id], onDelete: SetNull)
  members   WatchPartyMember[]
}

model WatchPartyMember {
  id        String   @id @default(uuid()) @db.Uuid
  party_id  String   @db.Uuid
  user_id   String   @db.Uuid
  joined_at DateTime @default(now())
  role      String   @default("participant") @db.VarChar(20)

  party WatchParty @relation(fields: [party_id], references: [id], onDelete: Cascade)
  user  User       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([party_id, user_id])
}

model UserFlagLog {
  id            String   @id @default(uuid()) @db.Uuid
  user_id       String   @db.Uuid
  admin_user_id String?  @db.Uuid
  action        String
  reason        String?
  created_at    DateTime @default(now())

  user       User  @relation("FlaggedUser", fields: [user_id], references: [id], onDelete: Cascade)
  admin_user User? @relation("AdminUser", fields: [admin_user_id], references: [id], onDelete: SetNull)
}

model HomepageSection {
  id            String             @id @default(uuid()) @db.Uuid
  title         String
  display_order Int                @default(0)
  is_visible    Boolean            @default(true)
  created_at    DateTime           @default(now())
  updated_at    DateTime           @updatedAt
  is_deleted    Boolean            @default(false)
  movie_links   SectionMovieLink[]
}

model SectionMovieLink {
  id            String   @id @default(uuid()) @db.Uuid
  section_id    String   @db.Uuid
  movie_id      String   @db.Uuid
  display_order Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  is_deleted    Boolean  @default(false)

  section HomepageSection @relation(fields: [section_id], references: [id], onDelete: Cascade)
  movie   Movie           @relation(fields: [movie_id], references: [id], onDelete: Cascade)

  @@unique([section_id, movie_id])
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  expiresAt DateTime
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}
